{% extends 'base.html' %}

{% load static %}
{% block title %} {{ room.room_name }} Chat {% endblock%}

{% block content %}
<link rel="stylesheet" href="{% static 'styles.css' %}">
<script src="https://unpkg.com/hyperscript.org@0.9.12"></script>
<div class="app-container">
    <div class="sidebar">
        <div class="profile-section">
            {% if user.profile.avatar %}
            <img src="{{ user.profile.avatar.url }}" alt="Profile" class="profile-pic">
            {% endif %}
            <span class="username">{{ user.username }}</span>
        </div>
        <!-- <div class="search-bar">
            <input type="text" placeholder="Search or start new chat">
        </div> -->
        <div class="chat-list">
            <p><strong>Room Members</strong></p>
            <hr>
            {%for m in members %}
            {% if m != request.user.profile %}
            <div class="chat-item">
                {% if m.avatar %}
                <img src="{{ m.avatar.url }}" alt="Contact" class="contact-pic">
                {% endif %}
                <div class="chat-info">
                    <span class="contact-name">{{ m.user.username }} </span>
                    <!-- <span class="last-message">Last message...</span> -->
                </div>
            </div>
            {% endif %}
            {% endfor %}
            <!--Add more chat items here  -->
        </div>
    </div>
    <div class="chat-window">
        <div class="chat-header">
            {% if room.avatar %}
            <img src="{{ room.avatar.url }}" alt="Contact" class="contact-pic">
            {% endif %}
            <span class="contact-name">{{ room.room_name }} Chat Room</span>
        </div>

        <!-- pulls the partial chat html -->

        {% include 'partial.html' %}

        <!-- end pulls -->

        <!-- <form id="demo_form" enctype="multipart/form-data"
            id="myForm"
            hx-post="{% url 'chat' room.room_name %}"
            hx-target="#test"
            hx-swap="outerHTML"
	    _="on htmx:afterRequest reset() me"
            > -->
        <form id="demo_form" enctype="multipart/form-data"
            id="myForm"
            hx-ext="{% url 'chat' room.room_name %}"
            hx-target="#test"
            hx-swap="outerHTML"
	        _="on htmx:afterRequest reset() me"
            >
            {% csrf_token %}
            <input name="file" type="file" id="filebtn" hidden>
            <span class="input-group-text attach_btn">
                <label for="filebtn">
                    <i class="fas fa-paperclip"></i>
                </label>
            </span>
            <div class="message-input">
                <input id="content" name="content" type="text" placeholder="Type a message" id="content" required>
                <button type="submit">Send</button>
            </div>
        </form>
    </div>
</div>

<script>
    // Establish websocket connection
    const room_name = '{{ room.room_name }}';
    const chatSocketURL = 'ws://' + window.location.host + '/ws/chat/' + room_name;
    const chatSocket = new WebSocket(chatSocketURL);

    // send message to the websocket
    const chatForm = document.getElementById("demo_form");
    chatForm.addEventListener("submit", function(event) {
        //prevent default submit
        event.preventDefault();

        let content = document.getElementById("content").value;

        chatSocket.send(
            JSON.stringify({
                "content": content,
            })
        )
    });


</script>
<script src="https://unpkg.com/htmx.org@1.9.12/dist/ext/ws.js"></script>
{% endblock %}

